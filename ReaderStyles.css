:root {
            /* V5 Color Scheme */
            --bg-color: #141218;
            --surface-color: #211f26;
            --surface-active: #2b2930;
            
            --primary-purple: #D0BCFF;
            --accent-purple: #7F5AF0;
            --muted-purple: #4a4458;
            
            --text-primary: #E6E1E5;
            --text-secondary: #CAC4D0;
            --text-tertiary: #938F99;
            
            /* Reader Theme Vars (Default Day) */
            --reader-bg: #f5f5f5;
            --reader-text: #333333;
            --reader-menu-bg: #ffffff;
            --reader-menu-text: #333333;
            --reader-font-size: 18px;
            --reader-line-height: 1.8;
            --tabbar-gap: 30px;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --reader-hud-text: rgba(0,0,0,0.42);
            --reader-hud-shadow: rgba(255,255,255,0.22);
        }
        
        /* Night Mode Override */
        body.night-mode {
            --reader-bg: #1a1a1a;
            --reader-text: #cccccc;
            --reader-menu-bg: #2c2c2e;
            --reader-menu-text: #ffffff;
            --reader-hud-text: rgba(255,255,255,0.45);
            --reader-hud-shadow: rgba(0,0,0,0.28);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        html, body {
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden;
            overscroll-behavior: none;
            margin: 0;
            padding: 0;
        }

        body, #root, .reader-content {
            transition: background-color 0.3s ease, color 0.3s ease !important;
        }

        input,
        textarea,
        [contenteditable="true"],
        .reader-content,
        .reader-content * {
            user-select: text;
            -webkit-user-select: text;
        }

        .debug-mode,
        .debug-mode * {
            user-select: text !important;
            -webkit-user-select: text !important;
        }

        body {
            background-color: #000;
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            perspective: 1500px;
        }

        /* Phone Simulator Frame (Desktop) */
        .phone-frame {
            width: 428px;
            height: 926px;
            background-color: var(--bg-color);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 60px rgba(127, 90, 240, 0.15);
            border-radius: 44px;
            border: 8px solid #222;
            transform: scale(var(--frame-scale, 1));
            transform-origin: center;
        }

        /* Mobile/PWA Mode Overrides */
        @media (max-width: 600px) {
            body {
                background-color: var(--bg-color);
                display: flex; /* Changed from block to flex to ensure centering if needed, but mostly to reset */
                flex-direction: column;
                height: 100vh;
                height: 100dvh;
                min-height: 100vh;
                overflow: hidden; 
                margin: 0;
                padding: 0;
            }
            .reader-view {
                height: 100dvh;
            }
            .phone-frame {
                width: 100vw;
                height: 100vh;
                height: 100dvh;
                min-height: 100vh;
                border: none;
                border-radius: 0;
                box-shadow: none;
                position: absolute;
                top: 0; left: 0;
                transform: none;
            }
            @supports (-webkit-touch-callout: none) {
                body { height: -webkit-fill-available; }
                .phone-frame { height: -webkit-fill-available; }
            }
            /* Request 2: Remove Status Bar in Mobile */
            .status-bar { display: none !important; }
            .header-container { padding-top: max(20px, env(safe-area-inset-top)); }
        }

        /* --- UI Components --- */
        .status-bar {
            height: 47px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 26px;
            font-size: 14px;
            font-weight: 600;
            z-index: 10;
            color: var(--text-primary);
            flex-shrink: 0;
        }

        /* View Container for Tabs */
        .view-section {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: absolute;
            top: 0; left: 0;
            background-color: var(--bg-color);
            transition: opacity 0.3s ease;
        }
        .view-section.hidden {
            opacity: 0;
            pointer-events: none;
            z-index: -1;
            visibility: hidden; /* Ensure it doesn't block clicks */
        }
        .view-section.active {
            opacity: 1;
            pointer-events: auto;
            z-index: 1;
            visibility: visible;
        }

        /* Scrollable Content Area */
        .scroll-content {
            flex: 1;
            overflow-y: auto;
            padding: 0 24px 100px 24px; /* Bottom padding for tab bar */
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        .scroll-content::-webkit-scrollbar { display: none; }

        .header-container {
            padding: 20px 24px 20px 24px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            min-height: 120px;
            position: relative;
            z-index: 5;
            flex-shrink: 0;
        }
        
        .header-glow {
            position: absolute;
            top: -50px; right: -50px;
            width: 200px; height: 200px;
            background: radial-gradient(circle, rgba(208, 188, 255, 0.15) 0%, rgba(20, 18, 24, 0) 70%);
            pointer-events: none;
        }

        .header-top-row {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
        }
        .date-display { font-size: 13px; text-transform: uppercase; letter-spacing: 1px; color: var(--primary-purple); font-weight: 600; }
        .header-title { font-size: 38px; font-weight: 800; letter-spacing: -0.5px; color: var(--text-primary); margin-bottom: 8px; }
        .header-subtitle { font-size: 16px; color: var(--text-secondary); }
        .avatar-btn {
            width: 40px; height: 40px; border-radius: 20px;
            background-color: var(--surface-color); border: 1px solid var(--muted-purple);
            display: flex; align-items: center; justify-content: center; color: var(--primary-purple);
            overflow: hidden;
        }
        .avatar-btn img { width: 100%; height: 100%; object-fit: cover; }

        /* Quick Actions */
        .quick-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px; }
        .action-card {
            background-color: var(--surface-color); padding: 16px; border-radius: 16px;
            display: flex; align-items: center; gap: 12px; cursor: pointer;
        }
        .action-card:active { background-color: var(--surface-active); transform: scale(0.98); }
        .action-icon {
            width: 36px; height: 36px; border-radius: 10px;
            background-color: rgba(208, 188, 255, 0.1); color: var(--primary-purple);
            display: flex; align-items: center; justify-content: center;
        }
        .action-text { font-size: 15px; font-weight: 600; }

        /* Section Header */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-top: 24px; margin-bottom: 16px; }
        .section-title { font-size: 20px; font-weight: 700; color: var(--text-primary); }
        .view-toggle-btn {
            background: none; border: none; color: var(--primary-purple); cursor: pointer;
            display: flex; align-items: center; gap: 6px; padding: 8px; border-radius: 8px;
        }

        /* Book Cards */
        .books-container { display: flex; flex-direction: column; gap: 16px; transition: all 0.3s ease; padding-bottom: 20px; }
        .book-card {
            display: flex; background-color: var(--surface-color); padding: 16px;
            border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            position: relative; overflow: hidden;
            transition: transform 0.2s, background-color 0.2s; cursor: pointer;
        }
        .book-card:active { transform: scale(0.98); background-color: var(--surface-active); }
        .book-cover {
            width: 70px; height: 105px; border-radius: 8px; margin-right: 18px;
            flex-shrink: 0; box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            background-size: cover; background-position: center; position: relative;
            background-color: #333;
        }
        /* Dynamic Cover Generator Styles */
        .dynamic-cover {
            display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
            color: white; padding: 5px; text-align: center;
        }
        .cover-1 { background: linear-gradient(135deg, #2b1f42 0%, #5e4b85 100%); }
        .cover-2 { background: linear-gradient(135deg, #1f2b42 0%, #4b6cb7 100%); }
        .cover-3 { background: linear-gradient(135deg, #421f1f 0%, #b74b4b 100%); }
        
        .cover-text {
            position: absolute; bottom: 6px; left: 6px; right: 6px;
            font-size: 10px; color: rgba(255,255,255,0.8); font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }
        .book-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .book-title { font-size: 18px; font-weight: 600; margin-bottom: 6px; color: var(--text-primary); line-height: 1.3; }
        .book-meta { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .format-badge {
            font-size: 10px; padding: 2px 6px; border-radius: 4px;
            background-color: var(--muted-purple); color: var(--text-secondary); font-weight: 600;
        }
        .progress-container { display: flex; align-items: center; gap: 12px; margin-bottom: 6px; }
        .progress-track { flex: 1; height: 6px; background-color: #35313d; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary-purple), var(--accent-purple)); border-radius: 3px; }
        .progress-text { font-size: 13px; color: var(--primary-purple); font-weight: 600; width: 35px; text-align: right; }
        .book-stats { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--text-tertiary); }
        .edit-btn {
            padding: 4px 8px; background: rgba(255,255,255,0.05); border-radius: 4px;
            color: var(--text-secondary); border: none; cursor: pointer; z-index: 5;
        }
        
        /* Grid View Overrides */
        .books-container.grid-view { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .books-container.grid-view .book-card { flex-direction: column; padding: 10px; gap: 8px; height: 100%; }
        .books-container.grid-view .book-cover { width: 100%; height: auto; aspect-ratio: 2/3; margin-right: 0; border-radius: 6px; }
        .books-container.grid-view .book-info { justify-content: flex-start; gap: 4px; }
        .books-container.grid-view .book-title {
            font-size: 13px; margin-bottom: 0; display: -webkit-box; -webkit-line-clamp: 2;
            -webkit-box-orient: vertical; overflow: hidden; height: 32px;
        }
        .books-container.grid-view .book-meta,
        .books-container.grid-view .progress-container,
        .books-container.grid-view .book-stats { display: none; }
        
        /* Tab Bar */
        .tab-bar {
            position: absolute; bottom: 30px; left: 24px; right: 24px; height: 80px;
            background-color: rgba(33, 31, 38, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 24px; display: flex; justify-content: space-around;
            align-items: center; padding: 0 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05);
            z-index: 50;
            padding-bottom: 0;
        }
        @media (max-width: 600px) {
            .tab-bar {
                position: fixed;
                left: 16px; right: 16px;
                bottom: calc(var(--tabbar-gap) + env(safe-area-inset-bottom));
                border-radius: 20px;
                height: 64px;
                padding-bottom: 0;
                margin-bottom: 0;
            }
            .scroll-content { padding-bottom: calc(100px + var(--tabbar-gap) + env(safe-area-inset-bottom)); }
        }
        .tab-item {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            justify-content: center; gap: 4px; color: var(--text-tertiary);
            transition: all 0.3s ease; cursor: pointer; height: 100%;
        }
        .tab-item.active { color: var(--primary-purple); }
        .tab-icon { width: 26px; height: 26px; stroke-width: 2px; }
        .tab-text { font-size: 11px; font-weight: 500; }

        /* --- Discover View Styles --- */
        .search-container {
            margin-bottom: 24px;
            position: relative;
        }
        .search-input {
            width: 100%;
            height: 50px;
            background: var(--surface-color);
            border: 1px solid var(--muted-purple);
            border-radius: 16px;
            padding: 0 20px 0 50px;
            color: white;
            font-size: 16px;
            outline: none;
        }
        .search-input:focus { border-color: var(--primary-purple); }
        .search-icon {
            position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
            color: var(--text-tertiary);
        }
        .search-results {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;
            min-height: 200px;
        }
        .search-item {
            display: flex; flex-direction: column; gap: 8px; cursor: pointer;
        }
        .search-cover {
            width: 100%; aspect-ratio: 2/3; background: #333; border-radius: 8px;
            background-size: cover; background-position: center;
        }
        .search-title { font-size: 12px; font-weight: 600; color: var(--text-primary); line-height: 1.3; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .search-author { font-size: 10px; color: var(--text-secondary); }

        /* --- Me View Styles --- */
        .profile-header {
            display: flex; flex-direction: column; align-items: center; padding: 20px 0;
        }
        .profile-avatar {
            width: 100px; height: 100px; border-radius: 50%;
            background: var(--surface-color); border: 2px solid var(--accent-purple);
            margin-bottom: 16px; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        .profile-name { font-size: 24px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px; }
        .profile-bio { font-size: 14px; color: var(--text-secondary); }
        
        .stats-row {
            display: flex; justify-content: space-around; width: 100%; margin: 30px 0;
            background: var(--surface-color); padding: 20px; border-radius: 20px;
        }
        .stat-item { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .stat-val { font-size: 20px; font-weight: 800; color: var(--primary-purple); }
        .stat-label { font-size: 12px; color: var(--text-tertiary); }

        .menu-list { display: flex; flex-direction: column; gap: 12px; }
        .menu-item {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--surface-color); padding: 16px 20px; border-radius: 16px;
            cursor: pointer;
        }
        .menu-item-left { display: flex; align-items: center; gap: 16px; font-weight: 600; font-size: 15px; }
        .menu-icon { color: var(--text-tertiary); }

        /* --- LAYERS (Animation & Reader) --- */
        
        /* Animation Layer */
        .animation-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 400; perspective: 1500px;
            visibility: hidden; pointer-events: none;
        }
        .animation-layer.active { visibility: visible; }

        .flying-book {
            position: absolute; transform-style: preserve-3d;
            transition: left 0.95s cubic-bezier(0.2, 0.8, 0.2, 1), top 0.95s cubic-bezier(0.2, 0.8, 0.2, 1), width 0.95s cubic-bezier(0.2, 0.8, 0.2, 1), height 0.95s cubic-bezier(0.2, 0.8, 0.2, 1), transform 0.95s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .flying-cover {
            position: absolute; width: 100%; height: 100%;
            border-radius: 6px; backface-visibility: hidden;
            background-size: cover; background-position: center;
            transform-origin: left center;
            transition: transform 1.05s cubic-bezier(0.2, 0.8, 0.2, 1), border-radius 0.3s;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.5);
        }
        .flying-cover::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #eee; transform: rotateY(180deg); backface-visibility: hidden;
        }
        .flying-page {
            position: absolute; width: 100%; height: 100%;
            background: var(--reader-bg); color: var(--reader-text); top: 0; left: 0;
            z-index: -1; box-shadow: 5px 5px 15px rgba(0,0,0,0.3);
            border-radius: 2px 6px 6px 2px; opacity: 0;
            transition: opacity 0.55s ease; padding: 20px; overflow: hidden;
            display: flex; flex-direction: column; justify-content: flex-start;
        }
        .flying-book.open .flying-cover { transform: rotateY(-160deg); border-radius: 2px 0 0 2px; }
        .flying-book.open .flying-page { opacity: 1; }

        /* Reader View */
        .reader-view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--reader-bg); color: var(--reader-text);
            z-index: 300; display: flex; flex-direction: column;
            overflow: hidden;
            overscroll-behavior: none;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transform: translateX(100%);
            transition: transform 260ms cubic-bezier(0.2, 0.8, 0.2, 1), opacity 260ms ease, visibility 0s linear 260ms;
            --reader-bottom-sheet: 0px;
        }
        .reader-view.active {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transform: translateX(0);
            transition: transform 260ms cubic-bezier(0.2, 0.8, 0.2, 1), opacity 260ms ease;
        }
        .reader-view.closing { opacity: 0; visibility: visible; pointer-events: none; transform: translateX(100%); }

        /* Fanqie-like Reader Menu */
        .reader-top-bar {
            position: absolute; top: 0; left: 0; right: 0;
            height: 56px;
            padding-top: env(safe-area-inset-top);
            padding-bottom: 6px;
            padding-left: 14px; padding-right: 14px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.45);
            color: #fff;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transform: translateY(-100%);
            opacity: 0;
            pointer-events: none;
            transition: transform 220ms cubic-bezier(0.2, 0.8, 0.2, 1), opacity 180ms ease;
            z-index: 310;
        }
        
        .reader-bottom-bar {
            position: fixed; left: 0; right: 0; bottom: 0;
            padding-top: 0;
            padding-left: 16px; padding-right: 16px;
            padding-bottom: env(safe-area-inset-bottom);
            margin-bottom: 0;
            background: rgba(0,0,0,0.45);
            color: #fff;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transform: translateY(100%);
            opacity: 0;
            pointer-events: none;
            transition: transform 220ms cubic-bezier(0.2, 0.8, 0.2, 1), opacity 180ms ease;
            z-index: 310;
            display: flex;
            flex-shrink: 0;
            align-items: center;
            justify-content: center;
            gap: 10px;
            height: calc(82px + env(safe-area-inset-bottom));
        }
        .reader-bottom-bar-inner {
            width: 100%;
            height: 82px;
            display: flex;
            align-items: center;
            justify-content: space-evenly;
            gap: 10px;
            padding-top: 0;
            padding-bottom: 0;
        }
        
        .reader-view.menu-visible .reader-top-bar { transform: translateY(0); opacity: 1; pointer-events: auto; }
        .reader-view.menu-visible .reader-bottom-bar { transform: translateY(0); opacity: 1; pointer-events: auto; }

        .reader-interaction-layer {
            position: absolute;
            inset: 0;
            z-index: 309;
            pointer-events: auto;
            background-color: transparent;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .reader-interaction-zone {
            position: absolute;
            pointer-events: none;
            display: none;
        }
        .reader-interaction-zone.corner {
            background: rgba(0,0,0,0.1);
        }
        .reader-interaction-zone.menu {
            inset: 0;
            background: rgba(0,0,0,0.06);
        }
        .debug-mode .reader-interaction-zone {
            display: block;
        }
        .reader-interaction-zone.corner.tl { left: 0; top: 0; width: 30%; height: 25%; }
        .reader-interaction-zone.corner.tr { right: 0; top: 0; width: 30%; height: 25%; }
        .reader-interaction-zone.corner.bl { left: 0; bottom: 0; width: 30%; height: 25%; }
        .reader-interaction-zone.corner.br { right: 0; bottom: 0; width: 30%; height: 25%; }

        .reader-content {
            flex: 1;
            position: relative;
            box-sizing: border-box;
            padding: calc(56px + env(safe-area-inset-top) + 18px) 24px calc(82px + env(safe-area-inset-bottom) + 18px + var(--reader-bottom-sheet)) 24px;
            font-family: "Georgia", serif; 
            font-size: var(--reader-font-size); 
            line-height: 32px !important;
            background-color: var(--reader-bg);
            overflow-y: auto; -webkit-overflow-scrolling: touch;
            overflow-x: hidden;
            overscroll-behavior-x: none;
            width: 100%;
            scrollbar-width: none;
            -ms-overflow-style: none;
            word-break: break-word;
            overflow-wrap: anywhere;
        }
        .reader-content-inner { min-height: 100%; width: 100%; }
        .mode-sim > .reader-content-inner { display: contents; }
        .reader-content::-webkit-scrollbar { width: 0; height: 0; display: none; }
        .reader-content * { max-width: 100%; }
        .reader-content p { scroll-margin-top: 72px; }
        .reader-content div,
        .reader-content h1,
        .reader-content h2,
        .reader-content h3 { scroll-margin-top: 20px; }

        .reader-view.menu-visible .reader-content {
            padding: calc(56px + env(safe-area-inset-top) + 18px) 24px calc(82px + env(safe-area-inset-bottom) + 18px + var(--reader-bottom-sheet)) 24px;
        }
        
        /* Flip Mode Styles */
        .mode-scroll { overflow-y: auto; overflow-x: hidden; touch-action: pan-y; }
        .reader-content.scroll {
            overflow-y: auto !important;
            overflow-x: hidden !important;
            touch-action: pan-y !important;
        }
        .flip-segment {
            position: relative;
            background: rgba(128,128,128,0.14);
            border-radius: 12px;
            padding: 4px;
            display: flex;
            gap: 0;
            user-select: none;
            -webkit-user-select: none;
        }
        .flip-indicator {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            width: calc((100% - 8px) / 2);
            border-radius: 8px;
            background: rgba(255,255,255,0.16);
            box-shadow: 0 8px 22px rgba(0,0,0,0.18);
            transform: translateX(0%);
            transition: transform 220ms cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .flip-option {
            position: relative;
            z-index: 1;
            flex: 1;
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            opacity: 0.72;
            transition: opacity 160ms ease;
        }
        .flip-option.active { opacity: 1; font-weight: 600; }
        .reader-mode-segment {
            position: relative;
            background: rgba(128,128,128,0.18);
            border-radius: 12px;
            padding: 4px;
            display: flex;
            gap: 0;
            user-select: none;
            -webkit-user-select: none;
        }
        .reader-mode-indicator {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            width: calc((100% - 8px) / 3);
            border-radius: 8px;
            background: rgba(255,255,255,0.92);
            box-shadow: 0 10px 26px rgba(0,0,0,0.16);
            transform: translateX(0%);
            transition: transform 220ms cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .reader-mode-option {
            position: relative;
            z-index: 1;
            flex: 1;
            text-align: center;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            opacity: 0.72;
            border: 0;
            background: transparent;
            color: inherit;
            transition: opacity 160ms ease;
        }
        .reader-mode-option.active { opacity: 1; font-weight: 600; color: #333333 !important; }
        .reader-mode-option--disabled { opacity: 0.35; cursor: not-allowed; }

        .reader-content.slide {
            height: 100vh !important;
            width: 100vw !important;
            box-sizing: border-box;
            column-width: 100vw;
            column-gap: 120px !important;
            column-fill: auto;
            overflow-x: scroll !important;
            overflow-y: hidden !important;
            touch-action: pan-x !important;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            transform: translateZ(0);
            will-change: scroll-position;
            padding: 0 !important;
        }
        .reader-content.slide .reader-content-inner {
            height: 100%;
            column-fill: auto;
            display: contents;
        }
        .reader-content.slide p {
            padding: 0 24px;
            margin-top: 56px;
            margin-bottom: 20px;
            break-inside: avoid;
            scroll-snap-align: start;
        }
        .reader-content.slide .reader-interaction-layer {
            display: none;
        }
        .mode-sim {
            overflow: hidden;
            height: 100%;
            padding: 0;
            padding: 0;
            position: relative;
            touch-action: pan-x;
        }
        .paged-page {
            flex: 0 0 100%;
            width: 100%;
            height: 100%;
            scroll-snap-align: start;
            box-sizing: border-box;
            padding: calc(56px + env(safe-area-inset-top) + 18px) 24px calc(82px + env(safe-area-inset-bottom) + 18px + var(--reader-bottom-sheet)) 24px;
            overflow: hidden;
        }
        .paged-text { white-space: pre-wrap; word-break: break-word; line-height: var(--reader-line-height); }
        .paged-line { line-height: var(--reader-line-height); }
        .paged-gap { height: calc(var(--reader-font-size) * 0.6); }
        .sim-surface { position: absolute; inset: 0; perspective: 1600px; }
        .sim-current, .sim-next, .sim-turn {
            position: absolute;
            inset: 0;
        }
        .sim-next { opacity: 0.98; }
        .sim-turn {
            transform-style: preserve-3d;
            backface-visibility: visible;
            box-shadow: 0 20px 40px rgba(0,0,0,0.25);
            pointer-events: none;
        }
        .sim-sheet { position: absolute; inset: 0; transform-style: preserve-3d; }
        .sim-front, .sim-back { position: absolute; inset: 0; backface-visibility: hidden; }
        .sim-back { transform: rotateY(180deg) scaleX(-1); filter: brightness(0.98); }
        .sim-shadow {
            position: absolute;
            inset: 0;
            pointer-events: none;
            opacity: 0;
            transition: opacity 180ms ease;
        }
        .sim-turn.turn-forward .sim-shadow {
            opacity: 1;
            background: linear-gradient(90deg, rgba(0,0,0,0.25), rgba(0,0,0,0.12), rgba(0,0,0,0.02), rgba(0,0,0,0));
        }
        .sim-turn.turn-backward .sim-shadow {
            opacity: 1;
            background: linear-gradient(270deg, rgba(0,0,0,0.25), rgba(0,0,0,0.12), rgba(0,0,0,0.02), rgba(0,0,0,0));
        }
        
        .reader-btn {
            background: none; border: none; font-size: 12px;
            color: var(--reader-menu-text); cursor: pointer;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            width: 60px;
        }
        .reader-btn svg { width: 24px; height: 24px; }
        .reader-bottom-bar .reader-btn { height: 60px; padding: 0; justify-content: center; line-height: 1; }
        .reader-bottom-bar .reader-btn span { line-height: 1; }

        .reader-title-wrap { display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .reader-page-indicator { font-size: 12px; opacity: 0.65; line-height: 1; }
        .reader-chapter-page-indicator {
            display: none;
        }
        .reader-bottom-status {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 0 16px env(safe-area-inset-bottom) 16px;
            height: calc(60px + env(safe-area-inset-bottom));
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--reader-hud-text);
            font-size: 13px;
            line-height: 1;
            letter-spacing: 0.2px;
            text-shadow: 0 1px 0 var(--reader-hud-shadow);
            background: linear-gradient(to top, rgba(0,0,0,0.28) 0%, rgba(0,0,0,0.18) 46%, rgba(0,0,0,0) 100%);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            pointer-events: none;
            opacity: 0;
            transition: opacity 180ms ease;
            z-index: 308;
        }
        body.night-mode .reader-bottom-status {
            background: linear-gradient(to top, rgba(0,0,0,0.58) 0%, rgba(0,0,0,0.38) 46%, rgba(0,0,0,0) 100%);
        }
        .reader-view.active:not(.menu-visible) .reader-bottom-status { opacity: 1; }
        .reader-bottom-status-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .reader-bottom-status-battery {
            display: inline-flex;
            align-items: center;
            opacity: 0.95;
        }
        .reader-bottom-status-battery.unknown {
            opacity: 0.55;
        }
        .reader-bottom-status-battery svg {
            width: 26px;
            height: 12px;
        }

        /* Settings Bar (Slide up) */
        .settings-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 9999;
            height: auto;
            max-height: 50vh;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            background: var(--reader-menu-bg);
            color: var(--reader-menu-text);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            pointer-events: none;
        }
        .settings-bar.active { transform: translateY(0); pointer-events: auto; }
        @media (max-width: 600px) {
            .settings-bar { max-height: calc(60vh + env(safe-area-inset-bottom)); }
        }
        
        .setting-row { margin-bottom: 24px; }
        .setting-label { font-size: 14px; margin-bottom: 10px; opacity: 0.7; font-weight: 600; }
        .theme-options { display: flex; gap: 16px; }
        .theme-circle {
            width: 48px; height: 48px; border-radius: 24px; border: 2px solid rgba(0,0,0,0.1);
            cursor: pointer; position: relative;
        }
        .theme-circle.active::after {
            content: ''; position: absolute; top: -4px; left: -4px; right: -4px; bottom: -4px;
            border-radius: 50%; border: 2px solid var(--accent-purple);
        }
        .theme-white { background: #f5f5f5; }
        .theme-sepia { background: #f4ecd8; }
        .theme-dark { background: #1a1a1a; border-color: #333; }
        .theme-green { background: #dcedc8; }
        
        .slider-container {
            display: flex; justify-content: space-between; align-items: center; 
            background: rgba(128,128,128,0.1); border-radius: 12px; padding: 12px 16px;
        }
        .slider-control {
            flex: 1; margin: 0 16px;
            -webkit-appearance: none; height: 4px; background: rgba(128,128,128,0.3); border-radius: 2px;
        }
        .slider-control::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; 
            background: var(--accent-purple); box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        /* Table of Contents (Slide Over) */
        .toc-panel {
            position: fixed;
            left: 0;
            right: 0;
            bottom: calc(82px + env(safe-area-inset-bottom));
            top: auto;
            width: 100%;
            height: 80vh;
            border-radius: 20px 20px 0 0;
            transform: translateY(120%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 200;
            background: var(--reader-menu-bg);
            color: var(--reader-menu-text);
            display: flex;
            flex-direction: column;
            overscroll-behavior: none;
            touch-action: pan-y;
            overflow: hidden;
        }
        .toc-panel.active {
            transform: translateY(0);
        }

        .toc-scroll {
            display: flex;
            flex-direction: column;
            height: 100%;
            flex: 1;
            min-height: 0;
            overflow: hidden;
            overscroll-behavior: none;
            touch-action: pan-y;
        }
        
        .toc-header {
            padding: 50px 24px 20px 24px;
            border-bottom: 1px solid rgba(128,128,128,0.1);
            position: relative;
            z-index: 1;
            background: var(--reader-menu-bg);
            flex-shrink: 0;
        }
        .toc-header-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
        .toc-title { font-size: 24px; font-weight: 800; }
        .toc-subtitle { font-size: 14px; opacity: 0.7; margin-top: 4px; }
        .toc-actions { display: inline-flex; align-items: center; gap: 8px; }
        .toc-action-btn {
            min-width: 44px; height: 32px;
            border-radius: 10px;
            border: 1px solid rgba(128,128,128,0.22);
            background: rgba(128,128,128,0.10);
            color: inherit;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0 10px;
            line-height: 1;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            font-size: 13px;
            font-weight: 700;
        }
        .toc-action-btn:active { opacity: 0.65; }
        
        .toc-list {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            -webkit-overflow-scrolling: touch;
            padding: 0 24px 40px 24px;
        }
        .toc-list::-webkit-scrollbar {
            width: 8px;
        }
        .toc-list::-webkit-scrollbar-track {
            background: transparent;
        }
        .toc-list::-webkit-scrollbar-thumb {
            background-color: transparent;
            border-radius: 3px;
            transition: background-color 0.3s ease;
        }
        .toc-list.scrolling::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.3);
        }
        .toc-item { 
            padding: 20px 0; border-bottom: 1px solid rgba(128,128,128,0.1); 
            font-size: 16px; cursor: pointer; display: flex; justify-content: space-between;
        }
        .toc-item-words { font-size: 12px; color: #888; flex-shrink: 0; margin-left: 12px; }
        .toc-item:active { opacity: 0.5; }
        .toc-item.active { color: var(--accent-purple); font-weight: 600; }

        .toc-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 190;
            opacity: 0; visibility: hidden; transition: opacity 0.3s;
        }
        .toc-overlay.active { opacity: 1; visibility: visible; }

        .selection-query-btn {
            position: absolute;
            z-index: 345;
            height: 32px;
            padding: 0 12px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.16);
            background: rgba(33, 31, 38, 0.95);
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            pointer-events: none;
            opacity: 0;
            transform: translateY(6px);
            transition: opacity 140ms ease, transform 180ms cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .selection-query-btn.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .query-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.45);
            z-index: 344;
            opacity: 0;
            visibility: hidden;
            transition: opacity 180ms ease;
            pointer-events: none;
        }
        .query-overlay.active {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        .query-panel {
            position: absolute;
            left: 0; right: 0; bottom: 0;
            z-index: 346;
            max-height: 62vh;
            padding: 16px 16px calc(16px + env(safe-area-inset-bottom)) 16px;
            background: var(--reader-menu-bg);
            color: var(--reader-menu-text);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -8px 26px rgba(0,0,0,0.22);
            transform: translateY(100%);
            transition: transform 240ms cubic-bezier(0.2, 0.8, 0.2, 1);
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .query-panel.active {
            transform: translateY(0);
            pointer-events: auto;
        }
        .query-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        .query-title {
            font-size: 15px;
            font-weight: 800;
        }
        .query-text {
            font-size: 13px;
            opacity: 0.75;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .query-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .query-action {
            height: 44px;
            border-radius: 12px;
            border: 1px solid rgba(128,128,128,0.18);
            background: rgba(128,128,128,0.08);
            color: inherit;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
        }
        .query-action:active { opacity: 0.7; }
        .query-result {
            flex: 1;
            min-height: 120px;
            border-radius: 14px;
            border: 1px solid rgba(128,128,128,0.14);
            background: rgba(128,128,128,0.06);
            padding: 12px;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }
        .query-result,
        .query-result * {
            user-select: text;
            -webkit-user-select: text;
        }
        .query-result-title { font-size: 14px; font-weight: 800; margin-bottom: 6px; }
        .query-result-meta { font-size: 12px; opacity: 0.75; margin-bottom: 10px; }
        .query-result-section { margin-top: 10px; }
        .query-result-section-title { font-size: 13px; font-weight: 800; margin-bottom: 6px; }
        .query-result-list { display: flex; flex-direction: column; gap: 6px; }
        .query-result-item { font-size: 13px; line-height: 1.55; opacity: 0.92; }
        .query-result-hint { font-size: 12px; opacity: 0.7; line-height: 1.55; }

        /* More Menu */
        .more-menu {
            position: absolute; top: 80px; right: 16px;
            width: 180px; background: var(--reader-menu-bg); color: var(--reader-menu-text);
            border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            padding: 8px; z-index: 340;
            opacity: 0; visibility: hidden; transform: scale(0.9); transform-origin: top right;
            transition: all 0.2s;
            top: calc(80px + env(safe-area-inset-top)); /* Adjust for notch */
        }
        .more-menu.active { opacity: 1; visibility: visible; transform: scale(1); }
        .more-item {
            padding: 12px 16px; display: flex; align-items: center; gap: 12px;
            font-size: 14px; border-radius: 8px; cursor: pointer;
        }
        .more-item:active { background: rgba(128,128,128,0.1); }

        /* Edit Modal */
        .modal-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 400; opacity: 0; visibility: hidden; transition: opacity 0.2s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; pointer-events: auto; }
        .modal-card {
            width: 300px; background: var(--surface-color); border-radius: 20px;
            padding: 24px; border: 1px solid var(--muted-purple);
            transform: scale(0.9); transition: transform 0.2s;
        }
        .modal-overlay.active .modal-card { transform: scale(1); }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--text-primary); }
        .modal-input {
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--muted-purple);
            color: white; padding: 12px; border-radius: 10px; font-size: 16px; margin-bottom: 20px; outline: none;
        }
        .modal-input:focus { border-color: var(--primary-purple); }
        .modal-actions { display: flex; justify-content: flex-end; gap: 12px; }
        .btn { padding: 10px 20px; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; border: none; }
        .btn-cancel { background: transparent; color: var(--text-secondary); }
        .btn-save { background: var(--accent-purple); color: white; }

.reader-status-icons { display: flex; gap: 6px; }

.reader-avatar-placeholder {
    width: 100%;
    height: 100%;
    background: #211f26;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #D0BCFF;
    font-weight: bold;
}
.reader-avatar-placeholder--lg { font-size: 40px; }

.reader-section-header--flush { margin-top: 0; }
.reader-header-container--compact { min-height: 80px; }

.reader-btn--icon { width: 40px; }
.reader-title-text { font-size: 14px; font-weight: 600; }

.reader-query-meta { display: flex; flex-direction: column; gap: 4px; min-width: 0; }
.reader-query-action--close { width: 72px; height: 36px; }

.reader-fontsize-display { float: right; opacity: 0.5; }
.reader-fontsize-minus { font-size: 14px; }
.reader-fontsize-plus { font-size: 20px; }

.reader-empty-state { grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-tertiary); }

.reader-grid-message { grid-column: 1/-1; text-align: center; padding: 20px; }
.reader-grid-message--secondary { color: var(--text-secondary); }

.reader-txt-chapter-title { margin: 40px 0 20px 0; font-weight: bold; color: var(--reader-text); }
.reader-txt-paragraph { margin-bottom: 16px; text-align: justify; }

.reader-message { text-align: center; }
.reader-message--pad-20 { padding: 20px; }
.reader-message--pad-40 { padding: 40px; }
.reader-message--secondary { color: var(--text-secondary); }
.reader-message--tertiary { color: var(--text-tertiary); }
.reader-message--error { color: #ff4d4f; }

.reader-flying-page-content { margin-top: 50px; }
.reader-flying-page-content--open { opacity: 0.3; }
.reader-flying-page-content--close { opacity: 0.25; }

.progress-fill--p0 { width: 0%; }
.progress-fill--p12 { width: 12%; }
.progress-fill--p45 { width: 45%; }
.progress-fill--p88 { width: 88%; }
